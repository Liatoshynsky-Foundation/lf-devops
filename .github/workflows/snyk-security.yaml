name: Security Snyk

on:
  workflow_call:
    secrets:
      SNYK_TOKEN:
        required: true
    inputs:
      node-version:
        required: true
        type: string
      docker-image-name:
        required: true
        type: string

jobs:
  snyk:
    permissions:
      contents: read
      security-events: write
      actions: read
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@806182742461562b67788a64410098c9d9b96adb

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies
        run: npm ci

      - name: Prepare SARIF directory
        run: mkdir -p sarif

      # --- SAST (Code) ---
      # Fails PR if High or Critical code vulnerabilities are found.
      - name: Snyk Code test (SARIF)
        run: snyk code test --fail-on=high --sarif-file-output=./sarif/snyk-code.sarif

      # --- SCA (Open Source) ---
      # Fails PR if High or Critical dependency vulnerabilities are found.
      - name: Snyk Open Source test (SARIF)
        run: snyk test --all-projects --fail-on=high --sarif-file-output=./sarif/snyk-oss.sarif --strict-out-of-sync=false
      
      - name: Snyk Open Source monitor
        run: snyk monitor --file=package-lock.json --package-manager=npm --strict-out-of-sync=false

      # --- IaC (Infrastructure as Code) ---
      # Fails PR if High or Critical IaC issues are found.
      - name: Snyk IaC test (SARIF)
        run: snyk iac test --fail-on=high --sarif-file-output=./sarif/snyk-iac.sarif
      
      - name: Snyk IaC test and report
        run: snyk iac test --report

      # --- Container Security ---
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/liatoshynsky-foundation/${{ inputs.docker-image-name }}:${{ github.sha }}

      # Fails PR if High or Critical container vulnerabilities are found.
      - name: Snyk Container test (SARIF)
        run: snyk container test ghcr.io/liatoshynsky-foundation/${{ inputs.docker-image-name }}:${{ github.sha }} --file=Dockerfile --exclude-app-vulns --fail-on=high --sarif-file-output=./sarif/snyk-container.sarif

      - name: Snyk Container monitor
        run: snyk container monitor ghcr.io/liatoshynsky-foundation/${{ inputs.docker-image-name }}:${{ github.sha }} --file=Dockerfile

      # --- SARIF Aggregation and Upload ---
      - name: Install SARIF Multitool
        run: dotnet tool install --global Sarif.Multitool --version 3.3.5

      - name: Combine Snyk SARIF files
        run: |
          sarif-multitool merge \
            sarif/snyk-code.sarif \
            sarif/snyk-oss.sarif \
            sarif/snyk-iac.sarif \
            sarif/snyk-container.sarif \
            --output sarif/snyk-all.sarif

      - name: Upload combined Snyk SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif/snyk-all.sarif
          category: snyk-combined

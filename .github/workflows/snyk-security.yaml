name: Security Snyk

on:
  workflow_call:
    secrets:
      SNYK_TOKEN:
        required: true
    inputs:
      node-version:
        required: true
        type: string
      docker-image-name:
        required: true
        type: string

jobs:
  snyk:
    permissions:
      contents: read
      security-events: write
      actions: read
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Snyk CLI
        uses: snyk/actions/setup@806182742461562b67788a64410098c9d9b96adb

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies
        run: npm ci

      - name: Prepare SARIF directory
        run: mkdir -p sarif

      - name: Snyk Code test (SARIF)
        run: snyk code test --fail-on=high --sarif-file-output=./sarif/snyk-code.sarif

      - name: Snyk Open Source monitor (lockfile, tolerate mismatch)
        run: snyk monitor --file=package-lock.json --package-manager=npm --strict-out-of-sync=false


      - name: Snyk Open Source test (SARIF, tolerate mismatch)
        run: snyk test --all-projects --fail-on=high --sarif-file-output=./sarif/snyk-oss.sarif --strict-out-of-sync=false 


      - name: Snyk IaC test and report
        run: snyk iac test --report --fail-on=high

      - name: Snyk IaC test (SARIF)
        run: snyk iac test --fail-on=high --sarif-file-output=sarif/snyk-iac.sarif


      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/liatoshynsky-foundation/${{ inputs.docker-image-name }}:${{ github.sha }}

      - name: Snyk Container monitor
        run: snyk container monitor ghcr.io/liatoshynsky-foundation/${{ inputs.docker-image-name }}:${{ github.sha }} --file=Dockerfile


      - name: Snyk Container test (SARIF)
        run: snyk container test ghcr.io/liatoshynsky-foundation/${{ inputs.docker-image-name }}:${{ github.sha }} --file=Dockerfile --exclude-app-vulns --fail-on=high --sarif-file-output=./sarif/snyk-container.sarif


      - name: Upload Snyk Code SARIF
        if: hashFiles('sarif/snyk-code.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif/snyk-code.sarif
          category: snyk-code

      - name: Upload Snyk OSS SARIF
        if: hashFiles('sarif/snyk-oss.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif/snyk-oss.sarif
          category: snyk-oss

      - name: Upload Snyk IaC SARIF
        if: hashFiles('sarif/snyk-iac.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif/snyk-iac.sarif
          category: snyk-iac

      - name: Upload Snyk Container SARIF
        if: hashFiles('sarif/snyk-container.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif/snyk-container.sarif
          category: snyk-container
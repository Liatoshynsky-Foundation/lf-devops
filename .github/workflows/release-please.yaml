name: Changelog

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.release.outputs.changelog }}
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add changelog comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changelog = process.env.CHANGELOG;
            const pr = context.payload.pull_request.number;
            if (changelog && pr) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr,
                body: `### ðŸ“œ Changelog Preview\n\n${changelog}`
              });
            }
        env:
          CHANGELOG: ${{ steps.release.outputs.changelog }}
